apiVersion: apps/v1
kind: Deployment
metadata:
  name: hasher-deploy
spec:
  replicas: 2
  selector:
    matchLabels:
      app: hasher
      app: dockercoins
  template:
    metadata:
      labels:
        app: hasher
        app: dockercoins
    spec:
      containers:
        -
          args:
            - hasher.rb
          command:
            - ruby
          image: celsohernando/hasher:latest
          name: hasher-container
          ports: 
            - 
              containerPort: 8080
              protocol: TCP
          volumeMounts:
            -
              mountPath: /hasher/hasher.rb
              name: hasher-volume
              readonly: true
              subPath: hasher.rb
          workingDir: /hasher/   
      volumes:
        -
          secret:
            defaultMode: 0400
            items:
              -
                key: hasher.rb
                mode: 0400
                path: hasher.rb
            secretName: hasher-secret
          name: hasher-volume
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-deploy
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
      app: dockercoins
  template:
    metadata:
      labels:
        app: redis
        app: dockercoins
    spec:
      containers:
        -
          args:
            - redis-server
          command:
            - docker-entrypoint.sh
          image: celsohernando/redis:latest
          name: redis-container
          ports: 
            - 
              containerPort: 6379
              protocol: TCP
          volumeMounts:
            -
              mountPath: /data/
              name: redis-volume
              readonly: false
          workingDir: /data/   
      volumes:
        -
          emptyDir:
            medium: Memory
            sizeLimit: 100Mi
          name: redis-volume
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: rng-ds
spec:
  selector:
    matchLabels:
      app: rng
      app: dockercoins
  template:
    metadata:
      labels:
        app: rng
        app: dockercoins
    spec:
      containers:
        -
          args:
            - rng.py
          command:
            - python
          image: celsohernando/rng:latest
          name: rng-container
          ports: 
            - 
              containerPort: 8080
              protocol: TCP
          volumeMounts:
            -
              mountPath: /rng/rng.py
              name: rng-volume
              readonly: true
              subPath: rng.py
          workingDir: /rng/   
      volumes:
        -
          secret:
            defaultMode: 0400
            items:
              -
                key: rng.py
                mode: 0400
                path: rng.py
            secretName: rng-secret
          name: rng-volume
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webui-deploy
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webui
      app: dockercoins
  template:
    metadata:
      labels:
        app: webui
        app: dockercoins
    spec:
      containers:
        -
          args:
            - webui.js
          command:
            - node
          image: celsohernando/webui:latest
          name: webui-container
          ports: 
            - 
              containerPort: 8080
              protocol: TCP
          volumeMounts:
            -
              mountPath: /webui/files/
              name: webui-files-volume
              readonly: true
            -
              mountPath: /webui/webui.js
              name: webui-volume
              readonly: true
              subPath: webui.js
          workingDir: /webui/   
      initContainers:
        -
          args:
            - clone
            - https://github.com/celsohernando/dockercoins
            - --branch
            - 2021-12-ibm
            - --single-branch
            - /dockercoins/
          image: celsohernando/git:latest
          name: webui-init-container
          volumeMounts:
            -
              mountPath: /dockercoins/
              name: webui-files-volume
              readonly: false
          workingDir: /dockercoins/   
      volumes:
        -
          persistentVolumeClaim:
            claimName: webui-files-pvc
            readOnly: false
          name: webui-files-volume
        -
          secret:
            defaultMode: 0400
            items:
              -
                key: webui.js
                mode: 0400
                path: webui.js
            secretName: webui-secret
          name: webui-volume
---
